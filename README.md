This code is modified on top of the effort by Alexandre Tkatchenko.